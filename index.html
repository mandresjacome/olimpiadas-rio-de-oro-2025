<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Competencia de Nataci√≥n</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(156,39,176,0.4); }
            50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(255,64,129,0.6); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üèä‚Äç‚ôÇÔ∏è Sistema de Competencia de Nataci√≥n</h1>
        <p>Gesti√≥n completa de eventos, participantes y resultados</p>
    </div>

    <div class="container">
        <!-- Navigation Menu -->
        <div class="nav-menu">
            <a href="index.html" class="nav-btn primary">
                üìã Dashboard
            </a>
            <a href="control-panel.html" class="nav-btn">
                ‚öôÔ∏è Panel de Control
            </a>
            <a href="settings.html" class="nav-btn" style="background: #FF9800;">
                üîß Configuraci√≥n
            </a>
            <a href="public-view.html" class="nav-btn success">
                üìä Resultados P√∫blicos
            </a>
        </div>

        <!-- Panel de Ayuda e Instrucciones (Desplegable) -->
        <div class="card" style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border-left: 5px solid #4CAF50;">
            <div class="card-header" style="background: transparent; border-bottom: 2px solid #4CAF50; cursor: pointer;" onclick="toggleHelpPanel()">
                <h2 style="color: #2E7D32; display: flex; align-items: center; justify-content: space-between;">
                    <span>üí° Gu√≠a de Uso - Configuraci√≥n del Evento</span>
                    <span id="helpPanelToggle" style="font-size: 1.5em; transition: transform 0.3s; transform: rotate(-90deg);">‚ñ∂</span>
                </h2>
            </div>
            <div id="helpPanelContent" style="padding: 20px; display: none;">
                <p style="font-size: 1.1em; margin-bottom: 20px; color: #1B5E20;">
                    <strong>Bienvenido al Panel de Configuraci√≥n</strong> - Aqu√≠ puedes preparar todo para las Olimpiadas R√≠o de Oro 2025
                </p>

                <!-- Botones de Acci√≥n R√°pida -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 3px solid #4CAF50;">
                    <h3 style="color: #2E7D32; margin-top: 0; text-align: center;">üöÄ Acciones R√°pidas</h3>
                    <div style="display: grid; gap: 15px;">
                        <!-- Configurar Todo -->
                        <div style="background: linear-gradient(135deg, #F3E5F5, #E1BEE7); padding: 15px; border-radius: 8px; border-left: 5px solid #9C27B0;">
                            <button onclick="configurarEventoCompleto()" style="width: 100%; background: linear-gradient(135deg, #FF4081, #9C27B0); color: white; font-weight: bold; font-size: 1.1em; padding: 15px 25px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(156,39,176,0.4); animation: pulse 2s infinite; margin-bottom: 10px;">
                                ‚ö° CONFIGURAR TODO AUTOM√ÅTICAMENTE ‚ö°
                            </button>
                            <p style="margin: 5px 0; line-height: 1.6; color: #4A148C;">
                                <strong>¬øPrimera vez?</strong> Este bot√≥n crea autom√°ticamente:
                            </p>
                            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6; color: #6A1B9A;">
                                <li>9 categor√≠as est√°ndar (Pre-Infantil A, B, Infantil A, B, Juvenil A, B, C, Mayores, M√°ster)</li>
                                <li>27 eventos/pruebas de nataci√≥n (50m, 100m, 200m en todos los estilos)</li>
                            </ul>
                            <p style="margin: 5px 0; color: #D32F2F; font-weight: bold;">‚ö†Ô∏è Solo √∫salo una vez al inicio!</p>
                        </div>

                        <!-- Generar Datos -->
                        <div style="background: linear-gradient(135deg, #F3E5F5, #E1BEE7); padding: 15px; border-radius: 8px; border-left: 5px solid #9C27B0;">
                            <button onclick="generateTestData()" style="width: 100%; background: #9C27B0; color: white; font-weight: bold; font-size: 1.05em; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 3px 10px rgba(156,39,176,0.3); margin-bottom: 10px;">
                                üé≤ Generar Datos Completos
                            </button>
                            <p style="margin: 5px 0; line-height: 1.6; color: #4A148C;">
                                <strong>Para pruebas:</strong> Genera datos de ejemplo completos incluyendo:
                            </p>
                            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6; color: #6A1B9A;">
                                <li>96 participantes de muestra con nombres realistas</li>
                                <li>Inscripciones autom√°ticas en las pruebas</li>
                                <li>Resultados simulados para hacer pruebas</li>
                            </ul>
                            <p style="margin: 5px 0; color: #FF6F00; font-weight: bold;">üí° √ötil para probar el sistema antes del evento real</p>
                        </div>

                        <!-- Limpiar Todo -->
                        <div style="background: linear-gradient(135deg, #FFEBEE, #FFCDD2); padding: 15px; border-radius: 8px; border-left: 5px solid #D32F2F;">
                            <button onclick="clearAllData()" style="width: 100%; background: #D32F2F; color: white; font-weight: bold; font-size: 1.05em; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 3px 10px rgba(211,47,47,0.3); margin-bottom: 10px;">
                                üóëÔ∏è Limpiar Todo
                            </button>
                            <p style="margin: 5px 0; line-height: 1.6; color: #B71C1C;">
                                <strong>¬°PELIGRO!</strong> Elimina TODA la informaci√≥n:
                            </p>
                            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6; color: #C62828;">
                                <li>Todas las categor√≠as</li>
                                <li>Todos los eventos/pruebas</li>
                                <li>Todos los participantes</li>
                                <li>Todas las inscripciones y resultados</li>
                            </ul>
                            <p style="margin: 5px 0; color: #D32F2F; font-weight: bold;">‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER - √ösalo solo si quieres empezar de cero</p>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Categor√≠as -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <h3 style="color: #1976D2; margin-top: 0;">üìã 1. Categor√≠as</h3>
                        <p style="margin: 10px 0; line-height: 1.6;">Define los grupos de edad de los nadadores (Ej: Sub-10, Sub-12, Juvenil, etc.)</p>
                        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>‚ûï Agregar Categor√≠a:</strong> Crea una nueva categor√≠a</li>
                            <li><strong>‚úèÔ∏è Editar:</strong> Modifica el nombre de una categor√≠a</li>
                            <li><strong>üóëÔ∏è Eliminar:</strong> Borra una categor√≠a (cuidado!)</li>
                        </ul>
                    </div>

                    <!-- Pruebas -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                        <h3 style="color: #F57C00; margin-top: 0;">üèÅ 2. Eventos/Pruebas</h3>
                        <p style="margin: 10px 0; line-height: 1.6;">Configura las competencias (Ej: 50m Libre, 100m Espalda, Relevo 4x50, etc.)</p>
                        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>‚ûï Agregar Evento:</strong> Crea una nueva prueba y as√≠gnala a una categor√≠a</li>
                            <li><strong>üîç Buscar:</strong> Filtra pruebas por nombre</li>
                            <li><strong>‚úèÔ∏è Editar:</strong> Cambia el nombre o categor√≠a</li>
                        </ul>
                    </div>

                    <!-- Participantes -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9C27B0;">
                        <h3 style="color: #7B1FA2; margin-top: 0;">üë§ 3. Participantes</h3>
                        <p style="margin: 10px 0; line-height: 1.6;">Registra todos los nadadores que competir√°n (nombre, club, g√©nero)</p>
                        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>‚ûï Agregar Participante:</strong> Registra un nuevo nadador</li>
                            <li><strong>üîç Buscar:</strong> Encuentra por nombre o club (sin tildes!)</li>
                            <li><strong>‚úèÔ∏è Editar:</strong> Actualiza datos del nadador</li>
                        </ul>
                    </div>
                </div>

                <div style="background: #E3F2FD; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #2196F3;">
                    <h3 style="color: #1565C0; margin-top: 0;">üìù Orden Recomendado</h3>
                    <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8; font-size: 1.05em;">
                        <li><strong>Paso 1:</strong> Crea las Categor√≠as (o usa configuraci√≥n autom√°tica)</li>
                        <li><strong>Paso 2:</strong> Agrega los Eventos/Pruebas para cada categor√≠a</li>
                        <li><strong>Paso 3:</strong> Registra a todos los Participantes</li>
                        <li><strong>Paso 4:</strong> Ve al <strong>üéÆ Panel de Control</strong> para inscribir nadadores en las pruebas</li>
                    </ol>
                </div>

                <div style="background: #FFEBEE; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #F44336;">
                    <h3 style="color: #C62828; margin-top: 0;">‚ö†Ô∏è Importante</h3>
                    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
        </div>

        <!-- Categories Section -->
        <div class="card">
            <div class="card-header">
                <h2>üìã Categor√≠as</h2>
                <div class="card-actions">
                    <button onclick="showCategoryModal()" class="btn btn-primary btn-sm">
                        ‚ûï Agregar Categor√≠a
                    </button>
                </div>
            </div>
            <div id="categoriesList" class="table-container">
                <table id="categoriesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre de Categor√≠a</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
                <div id="categoriesViewMore" style="text-align: center; margin-top: 15px; display: none;">
                    <button onclick="toggleViewCategories()" class="btn btn-secondary btn-sm" id="categoriesToggleBtn">
                        üìã Ver todos
                    </button>
                </div>
            </div>
        </div>

        <!-- Events Section -->
        <div class="card">
            <div class="card-header">
                <h2>üèÅ Eventos/Pruebas</h2>
                <div class="card-actions">
                    <button onclick="showEventModal()" class="btn btn-primary btn-sm">
                        ‚ûï Agregar Evento
                    </button>
                </div>
            </div>
            <div style="padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
                <input type="text" id="searchEvents" placeholder="üîç Buscar por nombre de prueba..." 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                       oninput="filterEvents()">
            </div>
            <div class="table-container">
                <table id="eventsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre del Evento</th>
                            <th>Categor√≠a</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="eventsBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
                <div id="eventsViewMore" style="text-align: center; margin-top: 15px; display: none;">
                    <button onclick="toggleViewEvents()" class="btn btn-secondary btn-sm" id="eventsToggleBtn">
                        üìã Ver todos
                    </button>
                </div>
            </div>
        </div>

        <!-- Participants Section -->
        <div class="card">
            <div class="card-header">
                <h2>üë§ Participantes</h2>
                <div class="card-actions">
                    <button onclick="showParticipantModal()" class="btn btn-primary btn-sm">
                        ‚ûï Agregar Participante
                    </button>
                </div>
            </div>
            <div style="padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
                <input type="text" id="searchParticipants" placeholder="üîç Buscar por nombre o club..." 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                       oninput="filterParticipants()">
            </div>
            <div class="table-container">
                <table id="participantsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Club/Equipo</th>
                            <th>G√©nero</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="participantsBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
                <div id="participantsViewMore" style="text-align: center; margin-top: 15px; display: none;">
                    <button onclick="toggleViewParticipants()" class="btn btn-secondary btn-sm" id="participantsToggleBtn">
                        üìã Ver todos (<span id="participantsHiddenCount">0</span> ocultos)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: linear-gradient(135deg, #2E7D32, #1B5E20); color: white; padding: 30px 20px; margin-top: 40px; text-align: center;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.5em;">üèä Olimpiadas R√≠o de Oro 2025</h3>
            <p style="margin: 5px 0; opacity: 0.9;">Sistema de Gesti√≥n de Competencias de Nataci√≥n</p>
            <p style="margin: 5px 0; opacity: 0.8; font-size: 0.9em;">üìÖ 2 de Noviembre, 2025 | üë• 96 Participantes | üèÜ 9 Categor√≠as</p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3);">
                <p style="margin: 0; font-size: 0.85em; opacity: 0.7;">Desarrollado con ‚ù§Ô∏è para la comunidad deportiva</p>
            </div>
        </div>
    </footer>

    <!-- Modal: Category -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Categor√≠a</h2>
                <button class="modal-close" onclick="closeCategoryModal()">‚úï</button>
            </div>
            <form onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label>Nombre de la Categor√≠a *</label>
                    <input type="text" id="categoryName" required placeholder="Ej: Infantil A">
                </div>
                <div class="flex gap-10">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Event -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Evento</h2>
                <button class="modal-close" onclick="closeEventModal()">‚úï</button>
            </div>
            <form onsubmit="saveEvent(event)">
                <div class="form-group">
                    <label>Nombre del Evento *</label>
                    <input type="text" id="eventName" required placeholder="Ej: 25M Crol o Libre">
                </div>
                <div class="form-group">
                    <label>Categor√≠a *</label>
                    <select id="eventCategory" required>
                        <option value="">Selecciona una categor√≠a</option>
                    </select>
                </div>
                <div class="flex gap-10">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEventModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Participant -->
    <div id="participantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Participante</h2>
                <button class="modal-close" onclick="closeParticipantModal()">‚úï</button>
            </div>
            <form onsubmit="saveParticipant(event)">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="participantName" required placeholder="Ej: Juan P√©rez">
                </div>
                <div class="form-group">
                    <label>Club o Equipo</label>
                    <input type="text" id="participantClub" placeholder="Ej: Club Neptuno">
                </div>
                <div class="form-group">
                    <label>G√©nero</label>
                    <select id="participantGender">
                        <option value="">Seleccionar</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
                <div class="flex gap-10">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeParticipantModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/database.js"></script>
    <script src="js/event-data.js"></script>
    <script src="js/sportland-participants-importer.js"></script>
    <script src="js/setup-complete-event.js"></script>
    <script src="js/clean-duplicates.js"></script>
    <script src="js/test-data-generator.js"></script>
    <script src="js/export.js"></script>
    <script>
        // Variables para control de vista
        let showAllCategories = false;
        let showAllEvents = false;
        let showAllParticipants = false;
        const MAX_VISIBLE_ROWS = 10;

        // Funci√≥n para normalizar texto (quitar tildes)
        function normalizeText(text) {
            if (!text) return '';
            return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        }

        // Funci√≥n para mostrar/ocultar panel de ayuda
        function toggleHelpPanel() {
            const content = document.getElementById('helpPanelContent');
            const toggle = document.getElementById('helpPanelToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.style.transform = 'rotate(0deg)';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.style.transform = 'rotate(-90deg)';
                toggle.textContent = '‚ñ∂';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        // Load all tables
        function loadAllData() {
            loadCategories();
            loadEvents();
            loadParticipants();
        }

        // ==================== CATEGORIES ====================
        
        function loadCategories() {
            const categories = db.getCategories();
            const tbody = document.getElementById('categoriesBody');
            const viewMoreDiv = document.getElementById('categoriesViewMore');
            const toggleBtn = document.getElementById('categoriesToggleBtn');
            
            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center" style="padding: 40px;">No hay categor√≠as. Agrega la primera categor√≠a.</td></tr>';
                viewMoreDiv.style.display = 'none';
                return;
            }

            const displayCategories = showAllCategories ? categories : categories.slice(0, MAX_VISIBLE_ROWS);
            
            tbody.innerHTML = displayCategories.map(cat => `
                <tr>
                    <td>${cat.category_id}</td>
                    <td>${cat.category_name}</td>
                    <td class="table-actions">
                        <button onclick="editCategory('${cat.category_id}', '${cat.category_name.replace(/'/g, "\\'")}')" class="btn btn-primary btn-sm">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deleteCategory('${cat.category_id}')" class="btn btn-danger btn-sm">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                </tr>
            `).join('');

            // Mostrar/ocultar bot√≥n "Ver todos"
            if (categories.length > MAX_VISIBLE_ROWS) {
                viewMoreDiv.style.display = 'block';
                toggleBtn.textContent = showAllCategories ? 'üìã Ver menos' : `üìã Ver todos (${categories.length - MAX_VISIBLE_ROWS} ocultos)`;
            } else {
                viewMoreDiv.style.display = 'none';
            }
        }

        function toggleViewCategories() {
            showAllCategories = !showAllCategories;
            loadCategories();
        }

        function showCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryName').removeAttribute('data-edit-id');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        function saveCategory(event) {
            event.preventDefault();
            const name = document.getElementById('categoryName').value;
            const editId = document.getElementById('categoryName').getAttribute('data-edit-id');
            
            if (editId) {
                // Editar categor√≠a existente
                db.updateCategory(editId, name);
                alert('‚úÖ Categor√≠a actualizada correctamente');
            } else {
                // Agregar nueva categor√≠a
                db.addCategory(name);
                alert('‚úÖ Categor√≠a agregada correctamente');
            }
            
            closeCategoryModal();
            loadAllData();
        }

        function editCategory(id, currentName) {
            document.getElementById('categoryModal').classList.add('active');
            document.getElementById('categoryName').value = currentName;
            document.getElementById('categoryName').setAttribute('data-edit-id', id);
        }

        function deleteCategory(id) {
            if (confirm('¬øEliminar esta categor√≠a?')) {
                db.deleteCategory(id);
                loadAllData();
            }
        }

        // ==================== EVENTS ====================
        
        function loadEvents() {
            const events = db.getEvents();
            const categories = db.getCategories();
            const tbody = document.getElementById('eventsBody');
            const viewMoreDiv = document.getElementById('eventsViewMore');
            const toggleBtn = document.getElementById('eventsToggleBtn');
            
            if (events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="padding: 40px;">No hay eventos. Agrega el primer evento.</td></tr>';
                viewMoreDiv.style.display = 'none';
                return;
            }

            const displayEvents = showAllEvents ? events : events.slice(0, MAX_VISIBLE_ROWS);

            tbody.innerHTML = displayEvents.map(evt => {
                const category = categories.find(c => c.category_id === evt.category_id);
                return `
                    <tr>
                        <td>${evt.event_id}</td>
                        <td>${evt.event_name}</td>
                        <td>${category ? category.category_name : 'N/A'}</td>
                        <td class="table-actions">
                            <button onclick="editEvent('${evt.event_id}', '${evt.event_name.replace(/'/g, "\\'")}', '${evt.category_id}')" class="btn btn-primary btn-sm">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteEvent('${evt.event_id}')" class="btn btn-danger btn-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mostrar/ocultar bot√≥n "Ver todos"
            if (events.length > MAX_VISIBLE_ROWS) {
                viewMoreDiv.style.display = 'block';
                toggleBtn.textContent = showAllEvents ? 'üìã Ver menos' : `üìã Ver todos (${events.length - MAX_VISIBLE_ROWS} ocultos)`;
            } else {
                viewMoreDiv.style.display = 'none';
            }
        }

        function toggleViewEvents() {
            showAllEvents = !showAllEvents;
            loadEvents();
        }

        function filterEvents() {
            const searchTerm = normalizeText(document.getElementById('searchEvents').value.trim());
            
            // Si no hay b√∫squeda, mostrar todos normalmente
            if (!searchTerm) {
                loadEvents();
                return;
            }
            
            const events = db.getEvents();
            const categories = db.getCategories();
            const tbody = document.getElementById('eventsBody');
            const viewMoreDiv = document.getElementById('eventsViewMore');
            
            const filtered = events.filter(e => 
                e.event_name && normalizeText(e.event_name).includes(searchTerm)
            );

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="padding: 40px;">No se encontraron pruebas que coincidan con la b√∫squeda.</td></tr>';
                viewMoreDiv.style.display = 'none';
                return;
            }

            const displayEvents = showAllEvents ? filtered : filtered.slice(0, MAX_VISIBLE_ROWS);
            
            tbody.innerHTML = displayEvents.map(evt => {
                const category = categories.find(c => c.category_id === evt.category_id);
                return `
                    <tr>
                        <td>${evt.event_id}</td>
                        <td>${evt.event_name}</td>
                        <td>${category ? category.category_name : 'N/A'}</td>
                        <td class="table-actions">
                            <button onclick="editEvent('${evt.event_id}', '${evt.event_name.replace(/'/g, "\\'")}', '${evt.category_id}')" class="btn btn-primary btn-sm">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteEvent('${evt.event_id}')" class="btn btn-danger btn-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (filtered.length > MAX_VISIBLE_ROWS) {
                viewMoreDiv.style.display = 'block';
                const toggleBtn = document.getElementById('eventsToggleBtn');
                toggleBtn.textContent = showAllEvents ? 'üìã Ver menos' : `üìã Ver todos (${filtered.length - MAX_VISIBLE_ROWS} ocultos)`;
            } else {
                viewMoreDiv.style.display = 'none';
            }
        }

        function showEventModal() {
            const categories = db.getCategories();
            if (categories.length === 0) {
                alert('‚ö†Ô∏è Primero debes crear al menos una categor√≠a');
                return;
            }

            const select = document.getElementById('eventCategory');
            select.innerHTML = '<option value="">Selecciona una categor√≠a</option>' +
                categories.map(cat => `<option value="${cat.category_id}">${cat.category_name}</option>`).join('');
            
            document.getElementById('eventModal').classList.add('active');
            document.getElementById('eventName').value = '';
            document.getElementById('eventName').removeAttribute('data-edit-id');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        function saveEvent(event) {
            event.preventDefault();
            const name = document.getElementById('eventName').value;
            const categoryId = document.getElementById('eventCategory').value;
            const editId = document.getElementById('eventName').getAttribute('data-edit-id');
            
            if (editId) {
                // Editar evento existente
                db.updateEvent(editId, name, categoryId);
                alert('‚úÖ Evento actualizado correctamente');
            } else {
                // Agregar nuevo evento
                db.addEvent(name, categoryId);
                alert('‚úÖ Evento agregado correctamente');
            }
            
            closeEventModal();
            loadAllData();
        }

        function editEvent(id, currentName, currentCategoryId) {
            const categories = db.getCategories();
            const select = document.getElementById('eventCategory');
            select.innerHTML = '<option value="">Selecciona una categor√≠a</option>' +
                categories.map(cat => `<option value="${cat.category_id}">${cat.category_name}</option>`).join('');
            
            document.getElementById('eventModal').classList.add('active');
            document.getElementById('eventName').value = currentName;
            document.getElementById('eventCategory').value = currentCategoryId;
            document.getElementById('eventName').setAttribute('data-edit-id', id);
        }

        function deleteEvent(id) {
            if (confirm('¬øEliminar este evento?')) {
                db.deleteEvent(id);
                loadAllData();
            }
        }

        // ==================== PARTICIPANTS ====================
        
        function loadParticipants() {
            const participants = db.getParticipants();
            const tbody = document.getElementById('participantsBody');
            const viewMoreDiv = document.getElementById('participantsViewMore');
            const toggleBtn = document.getElementById('participantsToggleBtn');
            const hiddenCount = document.getElementById('participantsHiddenCount');
            
            if (participants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px;">No hay participantes. Agrega el primer participante.</td></tr>';
                viewMoreDiv.style.display = 'none';
                return;
            }

            const displayParticipants = showAllParticipants ? participants : participants.slice(0, MAX_VISIBLE_ROWS);

            tbody.innerHTML = displayParticipants.map(p => `
                <tr>
                    <td>${p.participant_id}</td>
                    <td>${p.name}</td>
                    <td>${p.club_or_team || '-'}</td>
                    <td>${p.gender || '-'}</td>
                    <td class="table-actions">
                        <button onclick="editParticipant('${p.participant_id}', '${p.name.replace(/'/g, "\\'")}', '${p.club_or_team || ''}', '${p.gender || ''}')" class="btn btn-primary btn-sm">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deleteParticipant('${p.participant_id}')" class="btn btn-danger btn-sm">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                </tr>
            `).join('');

            // Mostrar/ocultar bot√≥n "Ver todos"
            if (participants.length > MAX_VISIBLE_ROWS) {
                viewMoreDiv.style.display = 'block';
                const hidden = participants.length - MAX_VISIBLE_ROWS;
                hiddenCount.textContent = hidden;
                toggleBtn.innerHTML = showAllParticipants 
                    ? 'üìã Ver menos' 
                    : `üìã Ver todos (<span id="participantsHiddenCount">${hidden}</span> ocultos)`;
            } else {
                viewMoreDiv.style.display = 'none';
            }
        }

        function toggleViewParticipants() {
            showAllParticipants = !showAllParticipants;
            loadParticipants();
        }

        function filterParticipants() {
            const searchTerm = normalizeText(document.getElementById('searchParticipants').value.trim());
            
            // Si no hay b√∫squeda, mostrar todos normalmente
            if (!searchTerm) {
                loadParticipants();
                return;
            }
            
            const participants = db.getParticipants();
            const tbody = document.getElementById('participantsBody');
            const viewMoreDiv = document.getElementById('participantsViewMore');
            
            const filtered = participants.filter(p => 
                (p.name && normalizeText(p.name).includes(searchTerm)) ||
                (p.club_or_team && normalizeText(p.club_or_team).includes(searchTerm))
            );

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px;">No se encontraron participantes que coincidan con la b√∫squeda.</td></tr>';
                viewMoreDiv.style.display = 'none';
                return;
            }

            const displayParticipants = showAllParticipants ? filtered : filtered.slice(0, MAX_VISIBLE_ROWS);
            
            tbody.innerHTML = displayParticipants.map(p => `
                <tr>
                    <td>${p.participant_id}</td>
                    <td>${p.name || ''}</td>
                    <td>${p.club_or_team || '-'}</td>
                    <td>${p.gender || '-'}</td>
                    <td class="table-actions">
                        <button onclick="editParticipant('${p.participant_id}', '${(p.name || '').replace(/'/g, "\\'")}', '${p.club_or_team || ''}', '${p.gender || ''}')" class="btn btn-primary btn-sm">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deleteParticipant('${p.participant_id}')" class="btn btn-danger btn-sm">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                </tr>
            `).join('');

            if (filtered.length > MAX_VISIBLE_ROWS) {
                const hidden = filtered.length - MAX_VISIBLE_ROWS;
                viewMoreDiv.style.display = 'block';
                const toggleBtn = document.getElementById('participantsToggleBtn');
                toggleBtn.innerHTML = showAllParticipants 
                    ? 'üìã Ver menos' 
                    : `üìã Ver todos (<span id="participantsHiddenCount">${hidden}</span> ocultos)`;
            } else {
                viewMoreDiv.style.display = 'none';
            }
        }

        function showParticipantModal() {
            document.getElementById('participantModal').classList.add('active');
            document.getElementById('participantName').value = '';
            document.getElementById('participantClub').value = '';
            document.getElementById('participantGender').value = '';
            document.getElementById('participantName').removeAttribute('data-edit-id');
        }

        function closeParticipantModal() {
            document.getElementById('participantModal').classList.remove('active');
        }

        function saveParticipant(event) {
            event.preventDefault();
            const name = document.getElementById('participantName').value;
            const club = document.getElementById('participantClub').value;
            const gender = document.getElementById('participantGender').value;
            const editId = document.getElementById('participantName').getAttribute('data-edit-id');
            
            if (editId) {
                // Editar participante existente
                db.updateParticipant(editId, name, club, gender);
                alert('‚úÖ Participante actualizado correctamente');
            } else {
                // Agregar nuevo participante
                db.addParticipant(name, club, gender);
                alert('‚úÖ Participante agregado correctamente');
            }
            
            closeParticipantModal();
            loadAllData();
        }

        function editParticipant(id, currentName, currentClub, currentGender) {
            document.getElementById('participantModal').classList.add('active');
            document.getElementById('participantName').value = currentName;
            document.getElementById('participantClub').value = currentClub;
            document.getElementById('participantGender').value = currentGender;
            document.getElementById('participantName').setAttribute('data-edit-id', id);
        }

        function deleteParticipant(id) {
            if (confirm('¬øEliminar este participante?')) {
                db.deleteParticipant(id);
                loadAllData();
            }
        }

        // ==================== UTILITIES ====================
        
        function clearAllData() {
            if (db.clearAllData()) {
                loadAllData();
                alert('‚úÖ Todos los datos han sido eliminados');
            }
        }
    </script>
</body>
</html>
